(function(){var g=_,l=Backbone;window.Offline={VERSION:"0.4.3",localSync:function(a,b,d,e){var c,h;return(c=function(){switch(a){case "read":return g.isUndefined(b.id)?e.findAll(d):e.find(b,d);case "create":return e.create(b,d);case "update":return e.update(b,d);case "delete":return e.destroy(b,d)}}())?d.success(b,null!=(h=c.attributes)?h:c,d):"function"===typeof d.error?d.error("Record not found"):void 0},sync:function(a,b,d){var e,c;return(e=b.storage||(null!=(c=b.collection)?c.storage:void 0))&&
null!=e&&e.support?Offline.localSync(a,b,d,e):l.ajaxSync(a,b,d)},onLine:function(){return!1!==navigator.onLine}};l.ajaxSync=l.sync;l.sync=Offline.sync;var j=Offline,c=function(a,b,d){this.name=a;this.collection=b;null==d&&(d={});this.support=this.isLocalStorageSupport();this.allIds=new Offline.Index(this.name,this);this.destroyIds=new Offline.Index(""+this.name+"-destroy",this);this.sync=new Offline.Sync(this.collection,this);this.keys=d.keys||{};this.autoPush=d.autoPush||!1};c.prototype.isLocalStorageSupport=
function(){try{return localStorage.setItem("isLocalStorageSupport","1"),localStorage.removeItem("isLocalStorageSupport"),!0}catch(a){return!1}};c.prototype.setItem=function(a,b){try{return localStorage.setItem(a,b)}catch(d){return"QUOTA_EXCEEDED_ERR"===d.name?this.collection.trigger("quota_exceed"):this.support=!1}};c.prototype.removeItem=function(a){return localStorage.removeItem(a)};c.prototype.getItem=function(a){return localStorage.getItem(a)};c.prototype.create=function(a,b){null==b&&(b={});
b.regenerateId=!0;return this.save(a,b)};c.prototype.update=function(a,b){null==b&&(b={});return this.save(a,b)};c.prototype.destroy=function(a,b){var d;null==b&&(b={});b.local||"new"===(d=a.get("sid"))||this.destroyIds.add(d);return this.remove(a,b)};c.prototype.find=function(a){return JSON.parse(this.getItem(""+this.name+"-"+a.id))};c.prototype.findAll=function(a){var b,d,c,f;null==a&&(a={});a.local||(this.isEmpty()?this.sync.full(a):this.sync.incremental(a));c=this.allIds.values;f=[];b=0;for(d=
c.length;b<d;b++)a=c[b],f.push(JSON.parse(this.getItem(""+this.name+"-"+a)));return f};c.prototype.s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};c.prototype.incrementId=16777216;c.prototype.localId1=(1048576*(1+Math.random())|0).toString(16).substring(1);c.prototype.localId2=(1048576*(1+Math.random())|0).toString(16).substring(1);c.prototype.mid=function(){return((new Date).getTime()/1E3|0).toString(16)+this.localId1+this.localId2+(++this.incrementId).toString(16).substring(1)};
c.prototype.guid=function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()};c.prototype.save=function(a,b){var d,c,f;null==b&&(b={});b.regenerateId&&(d="mid"===b.id?this.mid():this.guid(),a.set({sid:(null!=(c=a.attributes)?c.sid:void 0)||(null!=(f=a.attributes)?f.id:void 0)||"new",id:d}));b.local||a.set({updated_at:(new Date).toJSON(),dirty:!0});this.replaceKeyFields(a,"local");this.setItem(""+this.name+"-"+a.id,JSON.stringify(a));this.allIds.add(a.id);
this.autoPush&&!b.local&&this.sync.pushItem(a);return a};c.prototype.remove=function(a,b){var d;null==b&&(b={});this.removeItem(""+this.name+"-"+a.id);this.allIds.remove(a.id);d=a.get("sid");this.autoPush&&("new"!==d&&!b.local)&&this.sync.flushItem(d);return a};c.prototype.isEmpty=function(){return null===this.getItem(this.name)};c.prototype.clear=function(){var a,b,d,c,f,h=this;a=Object.keys(localStorage);a=g.filter(a,function(a){return RegExp(h.name).test(a)});d=0;for(c=a.length;d<c;d++)b=a[d],
this.removeItem(b);c=[this.allIds,this.destroyIds];f=[];b=0;for(d=c.length;b<d;b++)a=c[b],f.push(a.reset());return f};c.prototype.replaceKeyFields=function(a,b){var d,c,f,h,k,m,j;if(Offline.onLine())for(c in a.attributes&&(a=a.attributes),k=this.keys,k)if(d=k[c],f=a[c],!/^\w{8}-\w{4}-\w{4}/.test(f)||"local"!==b)d="local"===b?(h=new Offline.Collection(d),null!=(m=h.get(f))?m.id:void 0):null!=(j=d.get(f))?j.get("sid"):void 0,g.isUndefined(d)||(a[c]=d);return a};j.Storage=c;j=Offline;c=function(a,b){this.collection=
new Offline.Collection(a);this.storage=b};c.prototype.ajax=function(a,b,d){return Offline.onLine()?(this.prepareOptions(d),l.ajaxSync(a,b,d)):this.storage.setItem("offline","true")};c.prototype.full=function(a){var b=this;null==a&&(a={});return this.ajax("read",this.collection.items,g.extend({},a,{success:function(d,c,f){var h,k,g;b.storage.clear();b.collection.items.reset([],{silent:!0});k=0;for(g=c.length;k<g;k++)h=c[k],b.collection.items.create(h,{silent:!0,local:!0,regenerateId:!0});a.silent||
b.collection.items.trigger("reset");if(a.success)return a.success(d,c,f)}}))};c.prototype.incremental=function(a){var b=this;null==a&&(a={});return this.pull(g.extend({},a,{success:function(){return b.push()}}))};c.prototype.prepareOptions=function(a){var b,c=this;if(this.storage.getItem("offline"))return this.storage.removeItem("offline"),b=a.success,a.success=function(a,f,h){b(a,f,h);return c.incremental()}};c.prototype.pull=function(a){var b=this;null==a&&(a={});return this.ajax("read",this.collection.items,
g.extend({},a,{success:function(c,e,f){var h,g,j;b.collection.destroyDiff(e);g=0;for(j=e.length;g<j;g++)h=e[g],b.pullItem(h);if(a.success)return a.success(c,e,f)}}))};c.prototype.pullItem=function(a){var b;return(b=this.collection.get(a.id))?this.updateItem(a,b):this.createItem(a)};c.prototype.createItem=function(a){if(!g.include(this.storage.destroyIds.values,a.id.toString()))return a.sid=a.id,delete a.id,this.collection.items.create(a,{local:!0})};c.prototype.updateItem=function(a,b){if(new Date(b.get("updated_at"))<
new Date(a.updated_at))return delete a.id,b.save(a,{local:!0})};c.prototype.push=function(){var a,b,c,e,f;e=this.collection.dirty();b=0;for(c=e.length;b<c;b++)a=e[b],this.pushItem(a);e=this.storage.destroyIds.values;f=[];b=0;for(c=e.length;b<c;b++)a=e[b],f.push(this.flushItem(a));return f};c.prototype.pushItem=function(a){var b,c,e;this.storage.replaceKeyFields(a,"server");b=a.id;delete a.attributes.id;e="new"===a.get("sid")?["create",null]:["update",a.attributes.sid];c=e[0];a.id=e[1];this.ajax(c,
a,{success:function(b,e){"create"===c&&a.set({sid:e.id});return a.save({dirty:!1},{local:!0})}});a.attributes.id=b;return a.id=b};c.prototype.flushItem=function(a){var b,c=this;b=this.collection.fakeModel(a);return this.ajax("delete",b,{success:function(){return c.storage.destroyIds.remove(a)}})};j.Sync=c;j=Offline;c=function(a,b){var c;this.name=a;this.storage=b;this.values=(c=this.storage.getItem(this.name))&&c.split(",")||[]};c.prototype.add=function(a){g.include(this.values,a.toString())||this.values.push(a.toString());
return this.save()};c.prototype.remove=function(a){this.values=g.without(this.values,a.toString());return this.save()};c.prototype.save=function(){return this.storage.setItem(this.name,this.values.join(","))};c.prototype.reset=function(){this.values=[];return this.storage.removeItem(this.name)};j.Index=c;j=Offline;c=function(a){this.items=a};c.prototype.dirty=function(){return this.items.where({dirty:!0})};c.prototype.get=function(a){return this.items.find(function(b){return b.get("sid")===a})};c.prototype.destroyDiff=
function(a){var b,c,e,f,h;a=g.difference(g.without(this.items.pluck("sid"),"new"),g.pluck(a,"id"));h=[];c=0;for(e=a.length;c<e;c++)b=a[c],h.push(null!=(f=this.get(b))?f.destroy({local:!0}):void 0);return h};c.prototype.fakeModel=function(a){a=new l.Model({id:a});a.urlRoot=this.items.url;return a};j.Collection=c}).call(this);